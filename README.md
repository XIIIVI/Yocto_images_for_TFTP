# Description
This project offers a convenient way to generate images for Raspberry Pi by using [Yocto](https://www.yoctoproject.org/) combined with [Kas](https://kas.readthedocs.io/en/latest/).
Here is the list of supported images
| Image's name | Description |
|--|--|
| iotedge | An image embedding the Azure IoT Edge Runtime. It also supports the use of a TPM (Trusted Platform Module) |
| minimal | An extended version of the core-image-minimal |
| tftp | An image for a TFTP server in charge of distributing images across the network to other Rapsberries without any SD cards. |

 All the images also manage automatically external storage on NVMe HDD.

# Requirements
To make this project work, there are the following requirements for the machine in charge of generating the images:
* Docker 20.xx or greater,
* git (```sudo apt-get install -y git```),
* qemu-user-static (```sudo apt-get install -y qemu-user-static```),
* binfmt-support (```sudo apt-get install -y binfmt-support```)

WARNING: generating an image takes a while. To make the generation shorter, do not hesitate to use a powerful Virtual Machine (e.g with a 32 processor VM, generating the image `tftp` takes 45mn).
Anyway, as the generation is incremental, if you do not remove the folder `build`, anytime you generate the same image or another one sharing some recipes, the use of cached data will drastically reduce this operation.

# Command line
All the images can be generated by running the script `go.sh`.

The table below details the expected parameters.

| Parameter name | Default value | Mandatory (Y/N) | Description |
|--|--|--|--|
| `--build` | - | N | Used to build an image (by default) |
| `--clean` | - | N | Used to clean the build environment |
| `--data-dir` | /datadrive | N | Folder used to store user's data (Docker containers, ...) |
| `--devops` | - | N | Used to adapt the colored trace to Azure DevOps |
| `--hostname` | (1)  | N | Defines the hostname prefix |
| `--i2c-oled-display` | - | N | Integrate the management of an I2C OLED display | 
| `--image` | tftp | Y | Defines the image to build `tftp`, `iotedge`, `minimal` |
| `--machine` | raspberrypi4-64 | N | Defines the targetted Raspberry Pi's board: `raspberrypi-cm`, `raspberrypi-cm3`, `raspberrypi`, `raspberrypi0-wifi`, `raspberrypi0`, `raspberrypi2`, `raspberrypi3-64`, `raspberrypi3`, `raspberrypi4-64`, `raspberrypi4` |
| `--refspec` | hardknott | N | The version of Yocto to use (e.g dunfell, hardknott, ...) |
| `--root-password` |(2) | N | The root user's password |
| `--user-login` | (3) | N | Login of the user to create |
| `--user-password` | (4) | N | Password of the user to create |
| `--verbose` | - | N | Display the content of the files where token have been replaced |
| `--version` | (5) | N | Version of the image to generate |
| `--workdir` | The current directory | N | Folder where cache, temp files, ... are stored AND re-used |
| `--x735` | - | N | The target uses the [Geekworm X735 fan](https://wiki.geekworm.com/X735) |

(1) `tftp-server` if the image is `tftp`, 
    `minimal` if the image is `minimal`

(2) `PhU2018!`  if the image is `tftp`, 
    `Th3B0ss!` if the image is `minimal`

(3) `tftp`  if the image is `tftp`, 
    `raspberry` if the image is `minimal`
    
(4) `Is3r3_38`  if the image is `tftp`, 
    `JuR1_39` if the image is `minimal`

(5) Automatically retrieved by using GitVersion. In case of failure, the default value is `#-UNKNOWN-#`.

Example 1: generating an image for an TFTP Server embedding an OLED display and the Geekworm X735 hat, the command line looks like

`bash go.sh --image tftp --i2c-oled-display --x735`